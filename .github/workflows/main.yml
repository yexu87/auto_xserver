name: ğŸª„ XServerè‡ªåŠ¨ç­¾åˆ° (å¤šIPå¹¶è¡Œç‰ˆ)

on:
  schedule:
    # å¯¹åº”åŒ—äº¬æ—¶é—´ 06:06 (UTC 22:06)
    -  cron: "06 22 * * *"
    # å¯¹åº”åŒ—äº¬æ—¶é—´ 23:11 (UTC 15:11)
    -  cron: "11 15 * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    # çŸ©é˜µç­–ç•¥ (ä¿æŒä¸å˜)
    strategy:
      fail-fast: false
      matrix:
        # âš ï¸ è¯·æ ¹æ®ä½ çš„è´¦å·æ•°é‡ä¿®æ”¹è¿™é‡Œï¼ç´¢å¼•ä» 0 å¼€å§‹ã€‚
        # å¦‚æœä½ æœ‰ 2 ä¸ªè´¦å·ï¼Œå†™ [0, 1]
        account_index: [0, 1]

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt
          python -m playwright install chromium

      - name: ğŸ² éšæœºå»¶è¿Ÿ
        run: |
          delay=$((RANDOM % 60))
          echo "Random delay: ${delay}s"
          sleep $delay

      - name: è¿è¡Œè„šæœ¬
        env:
          XSERVER_BATCH: ${{ secrets.XSERVER_BATCH }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PROXY_SERVER: ${{ secrets.PROXY_SERVER }}
          USE_HEADLESS: "true"
          TARGET_INDEX: ${{ matrix.account_index }}
          
        run: python main.py

      - name: Commit time.txt to repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ matrix.account_index }}" == "0" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            if [ ! -f time.txt ]; then
              echo "Init: $(date +'%Y-%m-%d %H:%M:%S')" > time.txt
            else
              echo "$(date +'%Y-%m-%d %H:%M:%S')" > time.txt
            fi

            git add time.txt

            if git diff --cached --quiet; then
              echo "æ— å˜åŒ–"
            else
              git commit -m "â±ï¸ æ›´æ–°æ—¶é—´"
              git push origin HEAD:main
            fi
          else
            echo "è·³è¿‡æäº¤"
          fi
