name: ğŸª„ XServerè‡ªåŠ¨ç­¾åˆ° (å¤šIPå¹¶è¡Œç‰ˆ)

on:
  schedule:
    -  cron: "08 08 * * *"
    -  cron: "11 15 * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    # ğŸ‘‡ğŸ‘‡ğŸ‘‡ ã€æ ¸å¿ƒä¿®æ”¹ 1ã€‘é…ç½®çŸ©é˜µç­–ç•¥ ğŸ‘‡ğŸ‘‡ğŸ‘‡
    strategy:
      fail-fast: false  # å¦‚æœä¸€ä¸ªè´¦å·å¤±è´¥ï¼Œä¸è¦å–æ¶ˆå…¶ä»–è´¦å·çš„ä»»åŠ¡
      matrix:
        # âš ï¸ è¯·æ ¹æ®ä½ çš„è´¦å·æ•°é‡ä¿®æ”¹è¿™é‡Œï¼ç´¢å¼•ä» 0 å¼€å§‹ã€‚
        # å¦‚æœä½ æœ‰ 2 ä¸ªè´¦å·ï¼Œå†™ [0, 1]
        # å¦‚æœä½ æœ‰ 3 ä¸ªè´¦å·ï¼Œå†™ [0, 1, 2]
        account_index: [0, 1]

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt
          python -m playwright install chromium

      - name: ğŸ² éšæœºå»¶è¿Ÿ (é¿å…å®Œå…¨å¹¶å‘)
        run: |
          # è™½ç„¶IPä¸åŒäº†ï¼Œç¨å¾®é”™å¼€å‡ ç§’è¿˜æ˜¯å¥½çš„
          delay=$((RANDOM % 60))
          echo "Random delay: ${delay}s"
          sleep $delay

      - name: è¿è¡Œè„šæœ¬
        env:
          # ä¼ å…¥æ‰€æœ‰è´¦å·é…ç½®
          XSERVER_BATCH: ${{ secrets.XSERVER_BATCH }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PROXY_SERVER: ${{ secrets.PROXY_SERVER }}
          USE_HEADLESS: "true"
          
          # ğŸ‘‡ğŸ‘‡ğŸ‘‡ ã€æ ¸å¿ƒä¿®æ”¹ 2ã€‘æŠŠå½“å‰ä»»åŠ¡çš„ç¼–å·ä¼ ç»™ Python ğŸ‘‡ğŸ‘‡ğŸ‘‡
          # è¿™æ · Python è„šæœ¬å°±çŸ¥é“ï¼š"æˆ‘æ˜¯åˆ†èº«0ï¼Œæˆ‘åªè·‘ç¬¬1ä¸ªè´¦å·"
          TARGET_INDEX: ${{ matrix.account_index }}
          
        # âš ï¸ ç¡®ä¿ä½ çš„ Python æ–‡ä»¶åæ˜¯ main.py (å¯¹åº”ä¸Šä¸€æ¡å›å¤çš„ä»£ç )
        run: python main.py

      # ğŸ‘‡ğŸ‘‡ğŸ‘‡ ã€æ ¸å¿ƒä¿®æ”¹ 3ã€‘é˜²æ­¢ Git æäº¤å†²çª ğŸ‘‡ğŸ‘‡ğŸ‘‡
      # å› ä¸ºæœ‰å¤šä¸ªä»»åŠ¡å¹¶è¡Œè¿è¡Œï¼Œå¦‚æœå®ƒä»¬åŒæ—¶æäº¤ä»£ç ä¼šæŠ¥é”™ã€‚
      # æˆ‘ä»¬é™åˆ¶åªæœ‰ç¬¬ä¸€ä¸ªè´¦å· (ç´¢å¼•0) è´Ÿè´£æ›´æ–° time.txt
      - name: Commit time.txt to repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ matrix.account_index }}" == "0" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            if [ ! -f time.txt ]; then
              echo "é¦–æ¬¡ç”Ÿæˆæ—¶é—´ï¼š$(date +'%Y-%m-%d %H:%M:%S')" > time.txt
            else
              echo "$(date +'%Y-%m-%d %H:%M:%S')" > time.txt
            fi

            git add time.txt

            if git diff --cached --quiet; then
              echo "æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
            else
              git commit -m "â±ï¸ æ›´æ–°æ—¶é—´æ–‡ä»¶: $(date +'%Y-%m-%d %H:%M:%S')"
              git push origin HEAD:main
            fi
          else
            echo "å½“å‰æ˜¯åˆ†èº«ä»»åŠ¡ ${{ matrix.account_index }}ï¼Œè·³è¿‡æäº¤æ­¥éª¤ï¼Œé˜²æ­¢å†²çªã€‚"
          fi
