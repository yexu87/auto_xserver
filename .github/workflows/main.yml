name: ğŸª„ XServerè‡ªåŠ¨ç­¾åˆ°

on:
  schedule:
    -  cron: "08 08 * * *"
    -  cron: "11 15 * * *" # æ¯å¤© UTC 01:30 å’Œ 16:55ï¼ˆåŒ—äº¬æ—¶é—´åˆ†åˆ«æ˜¯ 09:30 å’Œ æ¬¡æ—¥ 00:55ï¼Œå› ä¸ºæˆ‘è‡ªå·±çš„æ—¶é—´æ˜¯16:50åˆ†ä¹‹åå¯ä»¥ç»­æœŸï¼Œæˆ‘ç»™äº†5åˆ†é’Ÿçš„é¢„ç•™ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆè¦2ä¸ªæ—¶é—´ç‚¹å‘¢ï¼Œå› ä¸ºæ€•ä¸€æ¬¡æ—¶é—´ç‚¹ç”±äºgithubçš„å®šæ—¶ä»»åŠ¡å»¶è¿Ÿä¼šé”™è¿‡ç»­æœŸæ—¶é—´ï¼Œä¹Ÿå°±æ˜¯16:50è¿™ä¸ªæ—¶é—´æ®µå¦‚æœé”™è¿‡åï¼Œ9ä¸ªå°æ—¶åæ‰§è¡Œç¬¬äºŒæ¬¡å®šæ—¶ã€‚ä¸€èˆ¬å°±ä¸ä¼šé”™è¿‡äº†ï¼‰
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt
          python -m playwright install chromium

      - name: ğŸ² å®šæ—¶ä»»åŠ¡åŸºç¡€ä¸Šéšæœºå»¶è¿Ÿï¼ˆ0-119ç§’ï¼‰
        run: |
          delay=$((RANDOM % 120))
          echo "Random delay: ${delay}s"
          sleep $delay

      - name: è¿è¡Œè„šæœ¬
        env:
          XSERVER_EMAIL: ${{ secrets.XSERVER_EMAIL }}
          XSERVER_PASSWORD: ${{ secrets.XSERVER_PASSWORD }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PROXY_SERVER: ${{ secrets.PROXY_SERVER }}
        run: python renew.py

      # â±ï¸ æäº¤ time.txt åˆ°ä»“åº“(ç”¨äºè§£å†³60å¤©æ— æ–‡ä»¶å˜åŒ–çš„é™åˆ¶)
      - name: Commit time.txt to repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ ! -f time.txt ]; then
            echo "é¦–æ¬¡ç”Ÿæˆæ—¶é—´ï¼š$(date +'%Y-%m-%d %H:%M:%S')" > time.txt
          else
            echo "$(date +'%Y-%m-%d %H:%M:%S')" > time.txt
          fi

          git add time.txt

          if git diff --cached --quiet; then
            echo "æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            git commit -m "â±ï¸ æ›´æ–°æ—¶é—´æ–‡ä»¶: $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin HEAD:main
          fi
