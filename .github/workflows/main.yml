name: ğŸª„ XServerè‡ªåŠ¨ç­¾åˆ°

on:
  schedule:
    -  cron: "08 08 * * *"
    -  cron: "11 15 * * *" # ä½ çš„è‡ªå®šä¹‰æ—¶é—´é…ç½®
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt
          python -m playwright install chromium

      - name: ğŸ² å®šæ—¶ä»»åŠ¡åŸºç¡€ä¸Šéšæœºå»¶è¿Ÿï¼ˆ0-119ç§’ï¼‰
        run: |
          delay=$((RANDOM % 120))
          echo "Random delay: ${delay}s"
          sleep $delay

      - name: è¿è¡Œè„šæœ¬
        env:
          # âœ… æ ¸å¿ƒä¿®æ”¹ï¼šè¿™é‡Œä¼ å…¥å¤šè´¦å·å˜é‡ XSERVER_BATCH
          XSERVER_BATCH: ${{ secrets.XSERVER_BATCH }}
          
          # ğŸ‘‡ å…¨å±€é»˜è®¤é€šçŸ¥é…ç½® (å¦‚æœ XSERVER_BATCH é‡ŒæŸè¡Œæ²¡å¡« Tokenï¼Œå°±ä¼šç”¨è¿™é‡Œçš„)
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          
          # ğŸ‘‡ ä»£ç†é…ç½®
          PROXY_SERVER: ${{ secrets.PROXY_SERVER }}
          
          # ğŸ‘‡ å¼ºåˆ¶å¼€å¯æ— å¤´æ¨¡å¼ (æœåŠ¡å™¨ç¯å¢ƒå¿…å¤‡)
          USE_HEADLESS: "true"
          
        # âš ï¸ æ³¨æ„ï¼šå¦‚æœä½ æŠŠ Python ä»£ç ä¿å­˜ä¸º renew.pyï¼Œè¯·å°†ä¸‹æ–¹ main.py æ”¹ä¸º renew.py
        run: python main.py

      # â±ï¸ æäº¤ time.txt åˆ°ä»“åº“(ç”¨äºè§£å†³60å¤©æ— æ–‡ä»¶å˜åŒ–çš„é™åˆ¶)
      - name: Commit time.txt to repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ ! -f time.txt ]; then
            echo "é¦–æ¬¡ç”Ÿæˆæ—¶é—´ï¼š$(date +'%Y-%m-%d %H:%M:%S')" > time.txt
          else
            echo "$(date +'%Y-%m-%d %H:%M:%S')" > time.txt
          fi

          git add time.txt

          if git diff --cached --quiet; then
            echo "æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            git commit -m "â±ï¸ æ›´æ–°æ—¶é—´æ–‡ä»¶: $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin HEAD:main
          fi
